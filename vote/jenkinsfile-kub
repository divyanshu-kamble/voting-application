pipeline {
    agent { label 'CI' } {
        kubernetes {
            defaultContainer 'jnlp'
            yaml '''
    apiVersion: v1
    kind: Pod
    metadata:
        namespace: jenkins-testing
        name: sample-kube
    spec:
      containers:
      - name: dind
        image: docker:24-dind
        volumeMounts:
        - mountPath: /var/build-data/
          name: jenkins-bld

      - name: python
        image: python:3.9.17-alpine3.18
        command:
        - sleep
        args:
        - 10s
        volumeMounts:
        - mountPath: /var/build-data/
          name: jenkins-bld
      volumes:
      - name: jenkins-bld
        persistentVolumeClaim:
          claimName: jenkins-build
'''
        }
}
        stages {
        stage('python container') {
            steps {
                container('python') {
                    sh '''
                    cd vote && ls -l
                    pip3 install -r requirements.txt
        '''
                }
            }
        }
        stage('Run in docker container') {
            steps {
                container('dind') {
                    sh '''
                    cd vote
                    docker build -t divyanshuk/vote:$BUILD_NUMBER -t divyanshuk/vote:latest .
                    '''
                }
            }
        }
        }
}
